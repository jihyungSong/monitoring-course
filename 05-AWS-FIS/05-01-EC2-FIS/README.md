# EC2 기반 3Tier 환경에 Fault Injection 테스트

1. CPU 스트레스 실험 템플릿 생성
2. CPU 스트레스 실험 대상 EC2 인스턴스에 태그 설정
3. CPU 스트레스 실험 시작
4. 메모리 스트레스 실험 



---
## 1. CPU 스트레스 실험 템플릿 생성
스트레스 테스트를 위해, AWS 서비스인 FIS (Fault Injection Service) 를 활용합니다.  
먼저 상단 검색 창에 `FIS` 를 검색하고, AWS FIS 서비스로 이동합니다.  

좌측 메뉴에 `복원력 테스트` 항목 중, `시나리오 라이브러리` 메뉴로 이동합니다.  
시나리오 중, `EC2 스트레스: CPU` 를 선택하고, `시나리오가 포함된 템플릿 생성` 버튼을 클릭 합니다.  

- 계정 타겟팅: `이 AWS 계정: XXXXXXXX` 선택 후 확인

실행 템플릿 셋팅된 그대로 사용

- 서비스 액세스: `실험 템플릿에 대한 새 역할 생성` 선택 후, 서비스 역할 이름 자동 셋팅된 그대로 사용
- 로그: 모두 선택하지 않음

실험 템플릿 생성 버튼을 클릭해 생성을 수행합니다.  


## 2. CPU 스트레스 실험 대상 EC2 인스턴스에 태그 설정

위 템플릿의 경우, 작업 대상 EC2 인스턴스 선정을 태그 값을 기준으로 선택 합니다.  
EC2 서비스 메뉴로 이동하여, 인스턴스 리스트에서 오토 스케일링 그룹으로 자동 생성된 EC2 인스턴스를 조회하고 선택합니다.  

EC2 인스턴스 필터에서 `태그` 항목 중 `aws:autoscaling:groupName`=`web-asg` 와 `aws:autoscaling:groupName`=`application-asg` 를 지정 후, 검색된 EC2 인스턴스의 태그 값에 아래와 같이 추가 합니다.

- `Ec2StressCpu`: `Allowed`

실험 대상이 잘 설정되었는지 확인하기 위해, `AWS FIS 서비스` 메뉴로 이동 하여, 실험 템플릿 메뉴로 이동합니다. 
위에서 생성한 실험 템플릿 을 선택 하고, `대상` 탭에서 `미리 보기 생성` 버튼을 눌러 실행 전 미리 대상 인스턴스를 찾아 봅니다. 
총, 2개의 인스턴스가 검색되어야 합니다. (`web-aag` 그룹에 한개, `application-asg` 그룹에서 한개)


## 3. CPU 스트레스 실험 시작

해당 실험 템플릿에서 `실험 시작` 버튼을 눌러 CPU 스트레스 테스트를 수행합니다.  
시나리오상 1차로 CPU 80% 로드로 290초를 지속하면서 부하를 발생시키고, 2차로 90% 로드로 290초, 3차로 100% 로드로 290초 동안 부하를 발생시킵니다.  

부하 발생 중에, Grafana 에 접속하여 상태를 살펴 봅니다. 
부하가 일어나는 와중에도 웹 서비스가 정상적으로 작동하는지 지속적으로 요청을 날려 보면서 모니터링을 통해 종합적인 상태를 체크 합니다.  

아래는 무한으로 Web ALB 로 요청을 보내는 쉘 스크립트 입니다. 

```
#!/bin/bash

URL="http://{ALB-DNS-주소}/"

while true; do
  echo "REQUEST"
  curl "$URL" >> /dev/null
done
```

## 4. 메모리 스트레스 실험

동일한 방법으로, 이번에는 메모리에 부하를 일으키면서 정상 동작을 체크해 봅니다. 

`복원력 테스트` 중 `시나리오 라이브러리` 중에서, `EC2 스트레스: 메모리` 를 선택하고, `시나리오가 포함된 템플릿 생성` 버튼을 클릭 합니다.  

인스턴스 태그에는 아래 항목을 추가 합니다. 

- `Ec2StressMemory`: `Allowed`

부하 발생 중에, Grafana 에 접속하여 상태를 살펴 봅니다. 
부하가 일어나는 와중에도 웹 서비스가 정상적으로 작동하는지 지속적으로 요청을 날려 보면서 모니터링을 통해 종합적인 상태를 체크 합니다.  
