# AWS 할당량 알람 받기

만약, 현재 최대 생성 가능한 리소스 대비 얼마나 사용중이며, 이에 근접한 사용율을 보일시 미리 알람을 받고 싶은 경우, Cloudwatch 를 통해 알람을 설정할 수 있습니다.  
아래와 같은 절차로 실습을 수행합니다.  

1. EC2 Spot Instance Request 사용에 대한 Cloudwatch 알람 생성 
2. Cloudwatch 경보에 대한 SNS 연동

--- 
## 1. EC2 Spot Instance Request 사용에 대한 Cloudwatch 알람 생성 

AWS 리소스 중, EC2 Spot 인스턴스에 대한 Quota 값과 요청량 대비 사용율에 대한 알람을 설정합니다.  
AWS 콘솔의 상단 통합 검색창에 `Service Quota` 로 검색하여 해당 서비스로 이동합니다.  

AWS 서비스 페이지에서 `EC2` 로 검색하여 `Amazon Elastic Compute Cloud (EC2)` 로 이동합니다.  
해당 서비스에 대한 할당량 목록 중, `All Standard(A,C,D,H,I,M,R,T,Z) Spot Instance Requests` 를 찾아서 선택 합니다.  

현재 계정에 설정된 할당량 값과 기본 할당량 값을 확인할 수 있습니다.  
모니터링 탭에서는 현재 할당량 대비 실제 사용율에 대한 그래프를 확인할 수 있습니다.  

경보 탭으로 이동하여, Amazon Cloudwatch 경보를 생성하도록 합니다.  
`생성` 버튼을 클릭합니다.  

경보 임계값에 아래와 같이 설정 합니다.  

- `적용된 할당량 값의 50%` 설정
- 경보 이름: `Half of Spot Instance Request Quota`

생성된 경보를 클릭하면, Cloudwatch 서비스로 이동됩니다.  
해당 경보에 대한 그래프와 지표 상태를 확인 가능합니다.  

## 2. Cloudwatch 경보에 대한 SNS 연동

해당 Cloudwatch 경보를 통해 Spot 인스턴스의 리소스 사용량이 할당량 대비 50% 이상이 넘어갈 경우, 경보가 발생하게 됩니다.  
하지만, 경보 자체가 생성되는 것이지 이에 따라 운영자에게 직접적인 알람이 오는 것은 아닙니다.  
운영자에게 직접적인 알람을 전달하기 위해서는 AWS SNS (Simple Notification Service) 를 활용하여 전파 채널로 알람 정보가 전달 되도록 설정해야 합니다.  

전파 채널의 경우, 지난 Pagerduty 실습때 설정했던 SNS 토픽 설정을 활용하도록 합니다.  
알람 설정을 위해, 해당 경보 페이지에서 `작업` -> `편집` 을 클릭 합니다. 

- 조건
  * 임계값 유형: 정적
  * 사용율(%) 조건: `보다 크거나 같음`
  * ...보다: `50`

으로 설정 후 다음을 클릭 합니다.  
알람 설정에 `알람 추가 버튼`을 클릭하고  

- 경보 상태 트리거: `경보 상태`
- 기존 SNS 주제 선택
- 다음으로 알람 전송 : `PagerDutyTest` (지난 실습때 사용한 토픽)

으로 설정 후 다음을 클릭 합니다.  

- 경보 설명: `Spot Instance 사용량이 할당량 대비 50%를 넘었습니다.` 

최종 확인 후, 업데이트를 완료 하도록 합니다.  
적용 완료되면 작업 탭에서 설정된 알림 확인이 가능합니다.  

